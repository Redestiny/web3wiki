// Web3Wiki - Main JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the application
    initApp();
    
    // Load featured tokens
    loadFeaturedTokens();
    
    // Setup event listeners
    setupEventListeners();
});

// Application State
const AppState = {
    tokens: [],
    searchResults: [],
    currentFilter: 'all'
};

// Initialize Application
function initApp() {
    console.log('Web3Wiki initialized');
    
    // Load sample data (in production, this would come from an API)
    loadSampleData();
    
    // Update stats (mock data for now)
    updateStats();
}

// Load Sample Data
function loadSampleData() {
    AppState.tokens = [
        {
            id: 1,
            name: 'Dogecoin',
            symbol: 'DOGE',
            address: '0x...',
            description: 'The original meme coin featuring the Shiba Inu dog.',
            category: 'meme',
            marketCap: '$10B',
            created: '2013'
        },
        {
            id: 2,
            name: 'Shiba Inu',
            symbol: 'SHIB',
            address: '0x...',
            description: 'The Dogecoin killer, community-driven token.',
            category: 'meme',
            marketCap: '$5B',
            created: '2020'
        },
        {
            id: 3,
            name: 'Pepe',
            symbol: 'PEPE',
            address: '0x...',
            description: 'Memetic frog token gaining viral popularity.',
            category: 'meme',
            marketCap: '$1B',
            created: '2023'
        },
        {
            id: 4,
            name: 'Uniswap',
            symbol: 'UNI',
            address: '0x...',
            description: 'Leading decentralized exchange protocol.',
            category: 'defi',
            marketCap: '$4B',
            created: '2018'
        },
        {
            id: 5,
            name: 'ApeCoin',
            symbol: 'APE',
            address: '0x...',
            description: 'Token for the Bored Ape Yacht Club ecosystem.',
            category: 'nft',
            marketCap: '$2B',
            created: '2022'
        }
    ];
}

// Load Featured Tokens
function loadFeaturedTokens() {
    const featuredTokens = AppState.tokens.slice(0, 4);
    const container = document.getElementById('featuredTokens');
    
    if (!container) return;
    
    container.innerHTML = featuredTokens.map(token => `
        <div class="token-card" data-id="${token.id}">
            <div class="token-icon">
                <i class="fas fa-coins"></i>
            </div>
            <h3 class="token-name">${token.name}</h3>
            <p class="token-symbol">${token.symbol}</p>
            <p class="token-category">${token.category.toUpperCase()}</p>
            <p class="token-marketcap">${token.marketCap}</p>
        </div>
    `).join('');
    
    // Add click handlers to token cards
    document.querySelectorAll('.token-card').forEach(card => {
        card.addEventListener('click', function() {
            const tokenId = parseInt(this.dataset.id);
            showTokenDetails(tokenId);
        });
    });
}

// Update Stats
function updateStats() {
    // Mock stats for now
    document.getElementById('tokenCount').textContent = '1,234';
    document.getElementById('contributorCount').textContent = '567';
    document.getElementById('editCount').textContent = '8,901';
}

// Setup Event Listeners
function setupEventListeners() {
    // Search functionality
    const heroSearchBtn = document.getElementById('heroSearchBtn');
    const mainSearchBtn = document.getElementById('mainSearchBtn');
    const heroSearchInput = document.getElementById('heroSearch');
    const mainSearchInput = document.getElementById('mainSearch');
    
    if (heroSearchBtn) {
        heroSearchBtn.addEventListener('click', () => performSearch(heroSearchInput.value));
    }
    
    if (mainSearchBtn) {
        mainSearchBtn.addEventListener('click', () => performSearch(mainSearchInput.value));
    }
    
    // Enter key support for search
    [heroSearchInput, mainSearchInput].forEach(input => {
        if (input) {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch(input.value);
                }
            });
        }
    });
    
    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Apply filter
            AppState.currentFilter = this.dataset.filter;
            applyFilter();
        });
    });
    
    // Add token form
    const submitBtn = document.getElementById('submitTokenBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', handleAddToken);
    }
    
    // Smooth scrolling for navigation
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            if (targetId === '#') return;
            
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
}

// Perform Search
function performSearch(query) {
    if (!query.trim()) {
        showToast('Please enter a search term', 'warning');
        return;
    }
    
    const results = AppState.tokens.filter(token => 
        token.name.toLowerCase().includes(query.toLowerCase()) ||
        token.symbol.toLowerCase().includes(query.toLowerCase()) ||
        token.description.toLowerCase().includes(query.toLowerCase())
    );
    
    AppState.searchResults = results;
    displaySearchResults(results);
    
    // Scroll to results
    document.getElementById('searchResults').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
    });
}

// Display Search Results
function displaySearchResults(results) {
    const container = document.getElementById('searchResults');
    if (!container) return;
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h3>No tokens found</h3>
                <p>Try a different search term or add the token to our wiki!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = results.map(token => `
        <div class="search-result-card">
            <div class="result-header">
                <h3>${token.name} (${token.symbol})</h3>
                <span class="result-category">${token.category.toUpperCase()}</span>
            </div>
            <p class="result-description">${token.description}</p>
            <div class="result-footer">
                <span class="result-marketcap">${token.marketCap}</span>
                <button class="result-view-btn" data-id="${token.id}">View Details</button>
            </div>
        </div>
    `).join('');
    
    // Add event listeners to view buttons
    document.querySelectorAll('.result-view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tokenId = parseInt(this.dataset.id);
            showTokenDetails(tokenId);
        });
    });
}

// Apply Filter
function applyFilter() {
    let filteredTokens = AppState.tokens;
    
    if (AppState.currentFilter !== 'all') {
        filteredTokens = AppState.tokens.filter(token => 
            token.category === AppState.currentFilter
        );
    }
    
    // Update featured tokens with filtered results
    const container = document.getElementById('featuredTokens');
    if (container) {
        container.innerHTML = filteredTokens.slice(0, 4).map(token => `
            <div class="token-card" data-id="${token.id}">
                <div class="token-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <h3 class="token-name">${token.name}</h3>
                <p class="token-symbol">${token.symbol}</p>
                <p class="token-category">${token.category.toUpperCase()}</p>
                <p class="token-marketcap">${token.marketCap}</p>
            </div>
        `).join('');
    }
}

// Handle Add Token
function handleAddToken() {
    const name = document.getElementById('tokenName').value.trim();
    const symbol = document.getElementById('tokenSymbol').value.trim().toUpperCase();
    const address = document.getElementById('tokenAddress').value.trim();
    const description = document.getElementById('tokenDescription').value.trim();
    const category = document.getElementById('tokenCategory').value;
    
    // Basic validation
    if (!name || !symbol || !address || !description) {
        showFormMessage('Please fill in all required fields', 'error');
        return;
    }
    
    // Validate address format (basic check)
    if (!address.startsWith('0x') || address.length < 20) {
        showFormMessage('Please enter a valid contract address', 'error');
        return;
    }
    
    // Create new token object
    const newToken = {
        id: AppState.tokens.length + 1,
        name,
        symbol,
        address,
        description,
        category,
        marketCap: 'New',
        created: new Date().getFullYear().toString()
    };
    
    // Add to state (in production, this would be an API call)
    AppState.tokens.push(newToken);
    
    // Show success message
    showFormMessage('Token submitted successfully! It will be reviewed by the community.', 'success');
    
    // Reset form
    document.getElementById('tokenName').value = '';
    document.getElementById('tokenSymbol').value = '';
    document.getElementById('tokenAddress').value = '';
    document.getElementById('tokenDescription').value = '';
    document.getElementById('tokenCategory').value = 'meme';
    
    // Update featured tokens
    loadFeaturedTokens();
    
    // Show toast notification
    showToast('Token submitted for review!', 'success');
}

// Show Token Details (placeholder)
function showTokenDetails(tokenId) {
    const token = AppState.tokens.find(t => t.id === tokenId);
    if (!token) return;
    
    showToast(`Viewing ${token.name} details (feature coming soon)`, 'info');
    
    // In a full implementation, this would show a modal or navigate to a details page
    console.log('Token details:', token);
}

// Show Form Message
function showFormMessage(message, type) {
    const messageEl = document.getElementById('formMessage');
    if (!messageEl) return;
    
    messageEl.textContent = message;
    messageEl.className = `form-message ${type}`;
    
    // Clear message after 5 seconds
    setTimeout(() => {
        messageEl.textContent = '';
        messageEl.className = 'form-message';
    }, 5000);
}

// Show Toast Notification
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    // Set message and type
    toast.textContent = message;
    toast.className = `toast ${type}`;
    
    // Show toast
    toast.classList.add('show');
    
    // Hide after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Add some CSS for search results
const additionalCSS = `
    .search-result-card {
        background: white;
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow);
    }
    
    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .result-category {
        background: var(--gray-light);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .result-description {
        color: var(--gray);
        margin-bottom: 1rem;
    }
    
    .result-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .result-marketcap {
        font-weight: bold;
        color: var(--success);
    }
    
    .result-view-btn {
        padding: 0.5rem 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
    }
    
    .result-view-btn:hover {
        background: var(--primary-dark);
    }
    
    .no-results {
        text-align: center;
        padding: 3rem;
        color: var(--gray);
    }
    
    .no-results i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
`;

// Inject additional CSS
const style = document.createElement('style');
style.textContent = additionalCSS;
document.head.appendChild(style);
